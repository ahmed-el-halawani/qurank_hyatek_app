name: Build & Release (Flutter) (Reusable)

on:
  workflow_call:
    outputs:
      tag_name:
        value: ${{ jobs.build_release.outputs.tag_name }}
      apk_name:
        value: ${{ jobs.build_release.outputs.apk_name }}
      pages_artifact_name:
        value: ${{ jobs.build_release.outputs.pages_artifact_name }}
      has_rnweb:
        value: ${{ jobs.build_release.outputs.has_rnweb }}

jobs:
  build_release:
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: write

    outputs:
      tag_name: ${{ steps.meta.outputs.tag_name }}
      apk_name: ${{ steps.meta.outputs.apk_name }}
      pages_artifact_name: ${{ steps.meta.outputs.pages_artifact_name }}
      has_rnweb: ${{ steps.detect.outputs.has_rnweb }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect RN Web folder
        id: detect
        run: |
          if [ -f "rnweb/package.json" ]; then
            echo "has_rnweb=true" >> $GITHUB_OUTPUT
          else
            echo "has_rnweb=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java (for Android build)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "2.7.0"   # <- your pinned version
          channel: stable
          cache: true
      
      - name: Print Flutter version
        run: flutter --version

          

      - name: Flutter Pub Get
        run: flutter pub get

      # Optional: version bump in Android (Flutter uses android/app/build.gradle typically)
      - name: Bump Android versionCode (best-effort)
        run: |
          if [ -f "android/app/build.gradle" ]; then
            sed -i 's/versionCode [0-9]\+/versionCode ${{ github.run_number }}/' android/app/build.gradle || true
          fi
          if [ -f "android/app/build.gradle.kts" ]; then
            sed -i 's/versionCode\s*=\s*[0-9]\+/versionCode = ${{ github.run_number }}/' android/app/build.gradle.kts || true
          fi

      - name: Build Android APK (Debug)
        run: flutter build apk --debug

      - name: Rename APK
        run: |
          APK_SRC="build/app/outputs/flutter-apk/app-debug.apk"
          if [ ! -f "$APK_SRC" ]; then
            echo "APK not found at $APK_SRC"
            find build -name "*.apk" -print || true
            exit 1
          fi

          APK_NAME="app-v1.0.${{ github.run_number }}.apk"
          cp "$APK_SRC" "$APK_NAME"
          echo "APK ready: $APK_NAME"

      - name: Build Flutter Web (Release)
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          # base-href is important for GitHub Pages under /<repo>/
          flutter build web --release --base-href "/${REPO_NAME}/"

      - name: Build RN Web (optional)
        if: ${{ steps.detect.outputs.has_rnweb == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: rnweb/package-lock.json

      - name: Install + Build RN Web (optional)
        if: ${{ steps.detect.outputs.has_rnweb == 'true' }}
        working-directory: rnweb
        run: |
          npm ci
          npm run build

          # NOTE:
          # To host under /<repo>/rn/, your RN web build must use relative asset paths or a correct public URL/basePath.
          # Adjust your RN build config if assets break on Pages.
          ls -la

      - name: Create Pages site folder (Flutter + optional RN)
        run: |
          rm -rf site
          mkdir -p site

          # Flutter web -> site/
          cp -R build/web/* site/

          # RN web -> site/rn/ (if detected)
          if [ "${{ steps.detect.outputs.has_rnweb }}" = "true" ]; then
            mkdir -p site/rn
            # Try common output folders (adjust if your RN output differs)
            if [ -d "rnweb/build" ]; then
              cp -R rnweb/build/* site/rn/
            elif [ -d "rnweb/dist" ]; then
              cp -R rnweb/dist/* site/rn/
            else
              echo "RN build output not found (expected rnweb/build or rnweb/dist)."
              exit 1
            fi
          fi

          # Quick check
          echo "Site contents:"
          find site -maxdepth 2 -type f | head -n 50

      - name: Zip Web build for Release asset (optional)
        run: |
          zip -r web-v1.0.${{ github.run_number }}.zip site

      - name: Set metadata outputs
        id: meta
        run: |
          echo "tag_name=v1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "apk_name=app-v1.0.${{ github.run_number }}.apk" >> $GITHUB_OUTPUT
          echo "pages_artifact_name=pages-site-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Upload Pages artifact (for Pages deploy workflow)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.pages_artifact_name }}
          path: site

      - name: Create GitHub Release (APK + Web zip)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: Release ${{ steps.meta.outputs.tag_name }}
          body: |
            Automatic build #${{ github.run_number }}
            - Version Code: ${{ github.run_number }}
            - Branch: ${{ github.ref_name }}
            - Flutter Web: GitHub Pages (see README)
            - RN Web: GitHub Pages (/rn) if present
          files: |
            ${{ steps.meta.outputs.apk_name }}
            web-v1.0.${{ github.run_number }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
